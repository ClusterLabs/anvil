(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[941],{91953:function(e,t,i){(window.__NEXT_P=window.__NEXT_P||[]).push(["/file-manager",function(){return i(52288)}])},21405:function(e,t,i){"use strict";i.d(t,{Z:function(){return components_Header}});var l=i(85893),n=i(41098),s=i(90948),r=i(42293),o=i(5616),a=i(82589),c=i(54799),d=i(67294),u=i(6010),h=i(25709),m=i(13540),p=i(77533),g=i(78462),x=i(97212),v=i(98619);let f=[{text:"Anvil",image:"/pngs/anvil_icon_on.png",uri:"/manage-element"},{text:"Files",image:"/pngs/files_on.png",uri:"/file-manager"},{text:"Configure",image:"/pngs/configure_icon_on.png",uri:"/config"},{text:"Mail",image:"/pngs/email_on.png",uri:"/mail-config"},{text:"Help",image:"/pngs/help_icon_on.png",uri:"https://alteeve.com/w/Support"}],j={width:"40em",height:"40em"};var Z=i(67645),w=i(57632),b=i(55238),F=i(41247),y=i(84154),k=i(34819);let C="AnvilDrawer",_={actionIcon:"".concat(C,"-actionIcon"),list:"".concat(C,"-list")},S=(0,s.ZP)(p.ZP)(()=>({["& .".concat(_.list)]:{width:"200px"},["& .".concat(_.actionIcon)]:{fontSize:"2.3em",color:u.of}}));var components_AnvilDrawer=e=>{let{open:t,setOpen:i}=e,{getSessionUser:n}=(0,k.Z)(),s=n();return(0,l.jsx)(S,{BackdropProps:{invisible:!0},anchor:"left",open:t,onClose:()=>i(!t),children:(0,l.jsx)("div",{role:"presentation",children:(0,l.jsxs)(g.Z,{className:_.list,children:[(0,l.jsx)(x.ZP,{children:(0,l.jsx)(y.Ac,{children:s?(0,l.jsxs)(l.Fragment,{children:["Welcome, ",s.name]}):"Unregistered"})}),(0,l.jsx)(w.Z,{}),(0,l.jsx)(v.Z,{component:"a",href:"/index.html",children:(0,l.jsxs)(b.Z,{fullWidth:!0,row:!0,spacing:"2em",children:[(0,l.jsx)(h.Z,{className:_.actionIcon}),(0,l.jsx)(y.Ac,{children:"Dashboard"})]})}),f.map(e=>(0,l.jsx)(v.Z,{component:"a",href:e.uri,children:(0,l.jsxs)(b.Z,{fullWidth:!0,row:!0,spacing:"2em",children:[(0,l.jsx)("img",{alt:e.text,src:e.image,...j}),(0,l.jsx)(y.Ac,{children:e.text})]})},"anvil-drawer-".concat(e.image))),(0,l.jsx)(v.Z,{onClick:()=>{Z.Z.put("/auth/logout").then(()=>{window.location.replace("/login")}).catch(e=>{(0,F.Z)(e)})},children:(0,l.jsxs)(b.Z,{fullWidth:!0,row:!0,spacing:"2em",children:[(0,l.jsx)(m.Z,{className:_.actionIcon}),(0,l.jsx)(y.Ac,{children:"Logout"})]})})]})})})},A=i(83909),M=i(66354);let I="Header",P={input:"".concat(I,"-input"),barElement:"".concat(I,"-barElement"),iconBox:"".concat(I,"-iconBox"),searchBar:"".concat(I,"-searchBar"),icons:"".concat(I,"-icons")},O=(0,s.ZP)(r.Z)(e=>{let{theme:t}=e;return{paddingTop:t.spacing(.5),paddingBottom:t.spacing(.5),paddingLeft:t.spacing(3),paddingRight:t.spacing(3),borderBottom:"solid 1px",borderBottomColor:u.hM,position:"static",["& .".concat(P.input)]:{height:"2.8em",width:"30vw",backgroundColor:t.palette.secondary.main,borderRadius:u.n_},["& .".concat(P.barElement)]:{padding:0},["& .".concat(P.iconBox)]:{[t.breakpoints.down("sm")]:{display:"none"}},["& .".concat(P.searchBar)]:{[t.breakpoints.down("sm")]:{flexGrow:1,paddingLeft:"15vw"}},["& .".concat(P.icons)]:{paddingLeft:".1em",paddingRight:".1em"}}});var components_Header=()=>{let e=(0,d.useRef)({}),t=(0,d.useRef)({}),[i,s]=(0,d.useState)(!1);return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(O,{children:(0,l.jsxs)(o.Z,{display:"flex",justifyContent:"space-between",flexDirection:"row",children:[(0,l.jsx)(b.Z,{row:!0,children:(0,l.jsx)(a.Z,{onClick:()=>s(!i),children:(0,l.jsx)("img",{alt:"",src:"/pngs/logo.png",width:"160",height:"40"})})}),(0,l.jsx)(b.Z,{className:P.iconBox,row:!0,spacing:0,children:(0,l.jsx)(o.Z,{children:(0,l.jsx)(c.Z,{onClick:e=>{var i,l;let{currentTarget:n}=e;null===(i=t.current.setAnchor)||void 0===i||i.call(null,n),null===(l=t.current.setOpen)||void 0===l||l.call(null,!0)},sx:{color:u.of,padding:"0 .1rem"},children:(0,l.jsx)(A.Z,{icon:n.Z,ref:e})})})})]})}),(0,l.jsx)(components_AnvilDrawer,{open:i,setOpen:s}),(0,l.jsx)(M.Z,{onFetchSuccessAppend:t=>{var i;null===(i=e.current.indicate)||void 0===i||i.call(null,Object.keys(t).length>0)},ref:t})]})}},58839:function(e,t,i){"use strict";var l=i(67294);t.Z=function(){let{actionProceedText:e="",content:t="",titleText:i="",...n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,l.useState)({actionProceedText:e,content:t,titleText:i,...n})}},52288:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return file_manager}});var l=i(85893),n=i(9008),s=i.n(n),r=i(21405),o=i(54490),a=i(67294),c=i(98436);let d=[["iso",["application/x-cd-image","ISO (optical disc)"]],["other",["text/plain","Other file type"]],["script",["text/plain","Script (program)"]]],u=new Map(d);var h=i(82175),m=i(25934),p=i(73393),g=i(67645),x=i(19467),v=i(53457),f=i(50361),j=i.n(f),Z=i(23279),w=i.n(Z),b=i(55238),F=i(63071),y=i(55675),k=i(37260),C=i(52886),_=i(84154),S=i(88468),Files_FileInputGroup=e=>{let{anvils:t,drHosts:i,fileUuid:n,formik:s,showSyncInputGroup:r,showTypeInput:o}=e,{handleBlur:c,handleChange:u}=s,h=(0,a.useMemo)(()=>w()(u,500),[u]),{nameChain:m,locationsChain:p,typeChain:g}=(0,a.useMemo)(()=>({nameChain:"".concat(n,".name"),locationsChain:"".concat(n,".locations"),typeChain:"".concat(n,".type")}),[n]),x=(0,a.useCallback)((e,t)=>{s.setValues(i=>{var l;let s=j()(i),r=null===(l=s[n].locations)||void 0===l?void 0:l[e];return r?(Object.keys(r).forEach(e=>{r[e].active=t}),s):i})},[s,n]),f=(0,a.useCallback)(e=>{var t;let i=null===(t=s.values[n].locations)||void 0===t?void 0:t[e];return i?{checked:Object.values(i).every(e=>{let{active:t}=e;return t}),onChange:(t,i)=>{x(e,i)}}:{}},[s.values,n,x]),Z=(0,a.useCallback)((e,t)=>{var i,l,r;let o="".concat(p,".").concat(e,".").concat(t),a="".concat(o,".active");return{id:a,name:a,checked:null===(r=s.values[n].locations)||void 0===r?void 0:null===(l=r[e])||void 0===l?void 0:null===(i=l[t])||void 0===i?void 0:i.active,onBlur:c,onChange:u}},[s.values,n,c,u,p]),A=(0,a.useCallback)(e=>{var t;let i=null===(t=s.values[n].locations)||void 0===t?void 0:t[e];return i&&Object.keys(i).length>1},[s.values,n]),M=(0,a.useMemo)(()=>(0,l.jsx)(S.Z,{input:(0,l.jsx)(y.Z,{id:m,label:"File name",name:m,onBlur:c,onChange:h,value:s.values[n].name})}),[h,s.values,n,c,m]),I=(0,a.useMemo)(()=>r&&(0,l.jsx)(k.TZ,{header:"Sync with node(s)",panelProps:{mb:0,mt:0,width:"100%"},children:(0,l.jsx)(F.Z,{allowCheckAll:A("anvils"),allowCheckItem:!0,edit:!0,header:!0,listItems:t,getListCheckboxProps:()=>f("anvils"),getListItemCheckboxProps:e=>Z("anvils",e),renderListItem:(e,t)=>{let{description:i,name:n}=t;return(0,l.jsxs)(_.Ac,{children:[n,": ",i]})}})}),[t,A,f,Z,r]),P=(0,a.useMemo)(()=>r&&(0,l.jsx)(k.TZ,{header:"Sync with DR host(s)",panelProps:{mb:0,mt:0,width:"100%"},children:(0,l.jsx)(F.Z,{allowCheckAll:A("drHosts"),allowCheckItem:!0,edit:!0,header:!0,listItems:i,getListCheckboxProps:()=>f("drHosts"),getListItemCheckboxProps:e=>Z("drHosts",e),renderListItem:(e,t)=>{let{hostName:i}=t;return(0,l.jsx)(_.Ac,{children:i})}})}),[i,A,f,Z,r]),O=(0,a.useMemo)(()=>o&&(0,l.jsx)(C.Z,{id:g,label:"File type",name:g,onBlur:c,onChange:u,selectItems:d.map(e=>{let[t,[,i]]=e;return{displayValue:i,value:t}}),value:s.values[n].type}),[s.values,n,c,u,o,g]);return(0,l.jsxs)(v.Z,{sx:{"& > :not(:first-child)":{marginTop:"1em"}},children:[(0,l.jsxs)(b.Z,{sm:"row",xs:"column",children:[M,O]}),I,P]})},A=i(43799),M=i(41247),I=i(68917),P=i(21642),O=i(16310),E=i(78438);let R=O.Ry({active:O.O7().required()}),B=O.Vo(e=>O.Ry((0,E.Z)(e,R))),D=O.Vo(e=>O.Ry((0,E.Z)(e,R))),L=O.Ry({locations:O.Ry({anvils:B,drHosts:D}),name:O.Z_().required(),type:O.Z_().oneOf(["iso","other","script"]),uuid:O.Z_().uuid().required()}),U=O.Vo(e=>O.Ry((0,E.Z)(e,L)));var V=i(5616),H=i(27072),Files_UploadFileProgress=e=>{let{uploads:t}=e;return(0,l.jsx)(b.Z,{columnSpacing:".2em",children:Object.values(t).map(e=>{let{name:t,progress:i,uuid:n}=e;return(0,l.jsxs)(V.Z,{sx:{alignItems:{md:"center"},display:"flex",flexDirection:{xs:"column",md:"row"},"& > :first-child":{minWidth:100,overflow:"hidden",overflowWrap:"normal",textOverflow:"ellipsis",whiteSpace:"nowrap",width:{xs:"100%",md:200},wordBreak:"keep-all"},"& > :last-child":{flexGrow:1}},children:[(0,l.jsx)(_.Ac,{children:t}),(0,l.jsx)(H.ko,{progressPercentage:i})]},"upload-".concat(n))})})};let setUploadProgress=(e,t,i)=>e?(e[t].progress=i,{...e}):e;var Files_AddFileForm=e=>{let{anvils:t,drHosts:i}=e,n=(0,a.useRef)(null),[s,r]=(0,a.useState)(),o=(0,h.TA)({initialValues:{},onSubmit:e=>{let t=Object.values(e);r(t.reduce((e,t)=>{let{file:i,name:l,uuid:n}=t;return i&&(e[n]={name:l,progress:0,uuid:n}),e},{}));let i=t.reduce((e,t)=>{let{file:i,name:l,uuid:n}=t;if(!i)return e;let s=new FormData;s.append("file",new File([i],l,{...i}));let o=g.Z.post("/file",s,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:e=>{let{loaded:t,total:i}=e;r(e=>setUploadProgress(e,n,Math.round(t/i*99)))}}).then(()=>{r(e=>setUploadProgress(e,n,100))});return e.push(o),e},[]);Promise.all(i).catch(e=>{let t=(0,M.Z)(e);t.children=(0,l.jsxs)(l.Fragment,{children:["Failed to add file. ",t.children]})})},validationSchema:U}),c=(0,a.useMemo)(()=>(0,A.Z)(o.errors),[o.errors]),d=(0,a.useMemo)(()=>!o.dirty||!o.isValid||o.isValidating||o.isSubmitting,[o.dirty,o.isSubmitting,o.isValid,o.isValidating]),u=(0,a.useCallback)(e=>{let{target:{files:t}}=e;if(!t)return;let i=Array.from(t).reduce((e,t)=>{let i=(0,m.Z)();return e[i]={file:t,name:t.name,uuid:i},e},{});o.setValues(i)},[o]),v=(0,a.useMemo)(()=>o.values&&Object.values(o.values).map(e=>{let{uuid:n}=e;return(0,l.jsx)(Files_FileInputGroup,{anvils:t,drHosts:i,fileUuid:n,formik:o},n)}),[t,i,o]);return(0,l.jsxs)(b.Z,{children:[(0,l.jsx)(I.Z,{children:"Uploaded files will be listed automatically, but it may take a while for larger files to finish uploading and appear on the list."}),s?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(I.Z,{children:"This dialog can be closed after all uploads complete. Closing before completion will stop the upload."}),(0,l.jsx)(Files_UploadFileProgress,{uploads:s})]}):(0,l.jsxs)(b.Z,{component:"form",onSubmit:e=>{e.preventDefault(),o.submitForm()},children:[(0,l.jsx)("input",{id:"files",multiple:!0,name:"files",onChange:u,ref:n,style:{display:"none"},type:"file"}),(0,l.jsx)(x.Z,{onClick:()=>{var e;null===(e=n.current)||void 0===e||e.click()},children:"Browse"}),v,(0,l.jsx)(P.Z,{count:1,messages:c}),(0,l.jsx)(p.Z,{actions:[{background:"blue",children:"Add",disabled:d,type:"submit"}]})]})]})},T=i(48882),N=i(56597),G=i(56211),W=i(57632);let toEditFileRequestBody=(e,t)=>{let{locations:i,name:l,type:n,uuid:s}=e;if(!i||!n)return;let r=[];return Object.entries(i.anvils).reduce((e,i)=>{let[l,{active:n}]=i,{anvils:{[l]:{locationUuids:s}}}=t,r=s.map(e=>({fileLocationUUID:e,isFileLocationActive:n}));return e.push(...r),e},r),Object.entries(i.drHosts).reduce((e,i)=>{let[l,{active:n}]=i,{hosts:{[l]:{locationUuids:s}}}=t,r=s.map(e=>({fileLocationUUID:e,isFileLocationActive:n}));return e.push(...r),e},r),{fileLocations:r,fileName:l,fileType:n,fileUUID:s}};var Files_EditFileForm=e=>{let{anvils:t,drHosts:i,onSuccess:n,previous:s}=e,r=(0,a.useRef)({}),o=(0,a.useCallback)(e=>{var t;return null===(t=r.current.setMessage)||void 0===t?void 0:t.call(null,"api",e)},[]),c=(0,a.useMemo)(()=>{let{locations:e,name:t,type:l,uuid:n}=s;return{[n]:{locations:Object.values(e).reduce((e,t)=>{let{active:l,anvilUuid:n,hostUuid:s}=t,r="anvils",o=n;return s in i&&(r="drHosts",o=s),e[r][o]={active:l},e},{anvils:{},drHosts:{}}),name:t,type:l,uuid:n}}},[i,s]),d=(0,h.TA)({initialValues:c,onSubmit:(e,t)=>{let{setSubmitting:i}=t,r=toEditFileRequestBody(e[s.uuid],s);g.Z.put("/file/".concat(s.uuid),r).then(()=>{o({children:(0,l.jsx)(l.Fragment,{children:"File updated."})}),null==n||n.call(null)}).catch(e=>{let t=(0,M.Z)(e);t.children=(0,l.jsxs)(l.Fragment,{children:["Failed to modify file. ",t.children]}),o(t)}).finally(()=>{i(!1)})},validationSchema:U}),u=(0,a.useMemo)(()=>(0,A.Z)(d.errors),[d.errors]),m=(0,a.useMemo)(()=>!d.dirty||!d.isValid||d.isValidating||d.isSubmitting,[d.dirty,d.isSubmitting,d.isValid,d.isValidating]);return(0,l.jsxs)(b.Z,{component:"form",onSubmit:e=>{e.preventDefault(),d.submitForm()},children:[(0,l.jsx)(Files_FileInputGroup,{anvils:t,drHosts:i,fileUuid:s.uuid,formik:d,showSyncInputGroup:!0,showTypeInput:!0}),(0,l.jsx)(P.Z,{count:1,messages:u,ref:r}),(0,l.jsx)(p.Z,{loading:d.isSubmitting,actions:[{background:"blue",children:"Edit",disabled:m,type:"submit"}]})]})},q=i(64666),z=i(81796),J=i(6903),X=i(32576),$=i(58839),K=i(67978);let toFileOverviewList=e=>e.reduce((e,t)=>{let[i,l,n,s,r]=t;return e[i]={checksum:r,name:l,size:n,type:s,uuid:i},e},{}),toFileDetail=e=>{let{0:t}=e;if(!t)return;let[i,l,n,s,r]=t;return e.reduce((e,t)=>{let{5:i,6:l,7:n,8:s,9:r,10:o,11:a,12:c}=t;e.anvils[n]||(e.anvils[n]={description:r,locationUuids:[],name:s,uuid:n}),e.hosts[o]||(e.hosts[o]={locationUuids:[],name:a,type:c,uuid:o}),"dr"===c?e.hosts[o].locationUuids.push(i):e.anvils[n].locationUuids.push(i);let d=1===Number(l);return e.locations[i]={anvilUuid:n,active:d,hostUuid:o,uuid:i},e},{anvils:{},checksum:r,hosts:{},locations:{},name:l,size:n,type:s,uuid:i})};var Files=()=>{let e=(0,a.useRef)(null),t=(0,a.useRef)({}),i=(0,a.useRef)(null),n=(0,a.useRef)({}),[s,r]=(0,$.Z)(),[d,h]=(0,a.useState)(!1),[m,p]=(0,a.useState)(),[x,v]=(0,a.useState)(),{isLoading:f}=(0,q.Z)("".concat(c.Z,"/file"),{onSuccess:e=>{v(toFileOverviewList(e))}}),{fetch:j,loading:Z}=(0,J.Z)({onData:e=>v(toFileOverviewList(e)),url:"/file"}),w=(0,a.useMemo)(()=>f||Z,[Z,f]),{buildDeleteDialogProps:y,checks:C,getCheck:S,hasAllChecks:A,hasChecks:M,multipleItems:I,resetChecks:O,setAllChecks:E,setCheck:R}=(0,X.Z)({list:x}),B=(0,a.useCallback)(e=>{var t;return null===(t=n.current.setMessage)||void 0===t?void 0:t.call(null,"api",e)},[]),{fetch:D,loading:L}=(0,J.Z)({onData:e=>p(toFileDetail(e)),onError:e=>{let{children:t,...i}=e;B({children:(0,l.jsxs)(l.Fragment,{children:["Failed to get file detail. ",t]}),...i})},url:"/file/"}),{data:U,loading:V}=(0,K.Z)("/anvil",{onError:e=>{B({children:(0,l.jsxs)(l.Fragment,{children:["Failed to get node list. ",e]}),type:"warning"})}}),H=(0,a.useMemo)(()=>U&&(0,T.Z)(U),[U]),{data:Q,loading:Y}=(0,K.Z)("/host?types=dr",{onError:e=>{B({children:(0,l.jsxs)(l.Fragment,{children:["Failed to get DR host list. ",e]}),type:"warning"})}}),ee=(0,a.useMemo)(()=>(0,l.jsx)(F.Z,{allowCheckAll:I,allowEdit:!0,allowItemButton:d,disableDelete:!M,edit:d,getListCheckboxProps:()=>({checked:A,onChange:(e,t)=>{E(t)}}),getListItemCheckboxProps:e=>({checked:S(e),onChange:(t,i)=>{R(e,i)}}),header:!0,listEmpty:"No file(s) found.",listItems:x,onAdd:()=>{var t;null===(t=e.current)||void 0===t||t.setOpen(!0)},onDelete:()=>{var e;r(y({onProceedAppend:()=>{let e=C.map(e=>g.Z.delete("/file/".concat(e)));Promise.all(e).then(()=>j()),O()},getConfirmDialogTitle:e=>"Delete the following ".concat(e," file(s)?"),renderEntry:e=>{let{key:t}=e;return(0,l.jsx)(_.Ac,{children:null==x?void 0:x[t].name})}})),null===(e=t.current.setOpen)||void 0===e||e.call(null,!0)},onEdit:()=>{h(e=>!e)},onItemClick:(e,t)=>{var l;null===(l=i.current)||void 0===l||l.setOpen(!0),D(t)},renderListItem:(e,t)=>{var i;let{checksum:n,name:s,size:r,type:a}=t;return(0,l.jsxs)(b.Z,{columnSpacing:0,fullWidth:!0,md:"row",xs:"column",children:[(0,l.jsxs)(b.Z,{spacing:0,flexGrow:1,children:[(0,l.jsxs)(b.Z,{row:!0,spacing:".5em",children:[(0,l.jsx)(_.$_,{children:s}),(0,l.jsx)(W.Z,{flexItem:!0,orientation:"vertical"}),(0,l.jsx)(_.Ac,{children:null===(i=u.get(a))||void 0===i?void 0:i[1]})]}),(0,l.jsx)(_.Ac,{children:(0,o._d)(r,{toUnit:"ibyte"})})]}),(0,l.jsx)(_.$_,{children:n})]})}}),[y,C,d,x,S,D,j,A,M,I,O,E,R,r]),et=(0,a.useMemo)(()=>w?(0,l.jsx)(z.Z,{}):ee,[w,ee]),ei=(0,a.useMemo)(()=>(0,l.jsx)(P.Z,{count:1,ref:n,usePlaceholder:!1}),[]),el=(0,a.useMemo)(()=>f||V||Y,[V,Y,f]),en=(0,a.useMemo)(()=>f||V||Y||L,[V,Y,L,f]),es=(0,a.useMemo)(()=>H&&Q&&(0,l.jsx)(Files_AddFileForm,{anvils:H,drHosts:Q}),[H,Q]),er=(0,a.useMemo)(()=>H&&Q&&m&&(0,l.jsx)(Files_EditFileForm,{anvils:H,drHosts:Q,onSuccess:()=>{j()},previous:m}),[H,Q,m,j]);return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(k.s_,{children:[(0,l.jsx)(k.V9,{children:(0,l.jsx)(_.z,{children:"Files"})}),ei,et]}),(0,l.jsx)(G.Js,{header:"Add file(s)",loading:el,ref:e,showClose:!0,wide:!0,children:es}),(0,l.jsx)(G.Js,{header:"Update file ".concat(null==m?void 0:m.name),loading:en,ref:i,showClose:!0,wide:!0,children:er}),(0,l.jsx)(N.Z,{closeOnProceed:!0,wide:!0,...s,ref:t})]})},file_manager=()=>(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s(),{children:(0,l.jsx)("title",{children:"File Manager"})}),(0,l.jsx)(r.Z,{}),(0,l.jsx)(Files,{})]})}},function(e){e.O(0,[494,804,416,50,213,461,264,486,775,675,633,380,774,888,179],function(){return e(e.s=91953)}),_N_E=e.O()}]);