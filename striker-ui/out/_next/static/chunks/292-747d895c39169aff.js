"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[292],{12882:(e,r,n)=>{n.d(r,{A:()=>h});var t=n(37876),o=n(77657),s=n(83221),i=n(35268),l=n(14232),a=n(10595),u=n(76847);let c=(0,i.Ay)(u.A)({backgroundColor:a.Qu});var d=n(77630);let m=(0,i.Ay)(o.A)({["& .".concat(s.A.paper)]:{backgroundColor:a.Qu}}),h=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];let[o]=r,{children:s,getItemDisabled:i,getItemHref:a,items:u={},onItemClick:h,open:p,renderItem:g,slotProps:v}=o,x=(0,l.useMemo)(()=>Object.entries(u),[u]),j=(0,l.useMemo)(()=>x.map(e=>{let[r,n]=e;if(r.includes("subheader"))return(0,t.jsx)(c,{children:null==g?void 0:g.call(null,r,n)},r);let o={disabled:null==i?void 0:i.call(null,r,n)},s=null==a?void 0:a.call(null,r,n);return s?(o.component="a",o.href=s):o.onClick=function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];return null==h?void 0:h.call(null,r,n,...t)},(0,t.jsx)(d.A,{...o,...null==v?void 0:v.item,children:null==g?void 0:g.call(null,r,n)},r)}),[i,a,h,x,g,null==v?void 0:v.item]);return(0,t.jsx)(m,{open:p,...null==v?void 0:v.menu,children:s||j})}},21967:(e,r,n)=>{n.d(r,{A:()=>d});var t=n(37876),o=n(7254),s=n(93901),i=n(15681),l=n(10595),a=n(41282),u=n(69146),c=n(43620);let d=e=>{let{id:r,label:n,inputWithLabelProps:d,messageBoxProps:m,onChange:h,selectItems:p,selectWithLabelProps:g,value:v}=e;return(0,t.jsxs)(o.A,{children:[(0,t.jsxs)(o.A,{sx:{display:"flex",flexDirection:"row","& > :first-child":{flexGrow:1},"& > :not(:last-child)":{marginRight:".5em"},["&:hover\n          .".concat(s.A.root,"\n          .").concat(i.A.root,"\n          .").concat(i.A.notchedOutline)]:{borderColor:l.Qu}},children:[(0,t.jsx)(u.A,{id:r,label:n,onChange:h,value:v,...d}),(0,t.jsx)(c.A,{formControlProps:{fullWidth:!1,sx:{minWidth:"min-content"}},id:"".concat(r,"-nested-select"),selectItems:p,...g})]}),(0,t.jsx)(a.A,{...m})]})}},22346:(e,r,n)=>{n.d(r,{W:()=>t});let t=["B","KiB","MiB","GiB","TiB"].map(e=>({value:e}))},43010:(e,r,n)=>{n.d(r,{A:()=>f});var t=n(37876),o=n(45363),s=n(97422),i=n(7254),l=n(58939),a=n(76847),u=n(15681),c=n(14924),d=n(28893),m=n(35268),h=n(50046),p=n.n(h),g=n(14232),v=n(10595),x=n(41282),j=n(69146);let y=e=>(0,t.jsx)(l.A,{in:!0,children:(0,t.jsx)(c.A,{...e})}),A=(0,m.Ay)("ul")({padding:0}),b=a.A,f=e=>{let{componentsProps:r,extendRenderInput:n,getGroupLabel:l,label:a,ListboxProps:c,messageBoxProps:m,renderGroup:h,renderInput:f,required:k,sx:O,...C}=e,I=(0,g.useMemo)(()=>p()({paper:{sx:{backgroundColor:v.Qu,["& .".concat(o.A.groupLabel)]:{backgroundColor:v.Qu}}}},r),[r]),w=(0,g.useMemo)(()=>p()({sx:{["& .".concat(o.A.option)]:{'&[aria-selected="true"]':{backgroundColor:v.a$,["&.".concat(o.A.focused)]:{backgroundColor:v.a$}},["&.".concat(o.A.focused)]:{backgroundColor:v.a$}}}},c),[c]),M=(0,g.useMemo)(()=>h||l&&(e=>(0,t.jsxs)("li",{children:[(0,t.jsx)(b,{component:"div",className:o.A.groupLabel,children:l(e.group)}),(0,t.jsx)(A,{className:o.A.groupUl,children:e.children})]},e.key)),[l,h]),G=(0,g.useMemo)(()=>null!=f?f:e=>{let{fullWidth:r,InputProps:o,InputLabelProps:s,inputProps:i}=e,l={formControlProps:{fullWidth:r,ref:o.ref},inputLabelProps:s,inputProps:{className:o.className,endAdornment:o.endAdornment,inputProps:i,startAdornment:o.startAdornment,sx:{["& .".concat(u.A.input)]:{margin:0}}},label:a,required:k,value:i.value};return null==n||n.call(null,l,e),(0,t.jsx)(j.A,{...l})},[n,a,f,k]),B=(0,g.useMemo)(()=>p()({["& .".concat(u.A.root," .").concat(o.A.endAdornment)]:{right:"7px",["& .".concat(d.A.root)]:{color:v.Qu}}},O),[O]);return(0,t.jsxs)(i.A,{sx:{display:"flex",flexDirection:"column"},children:[(0,t.jsx)(s.A,{autoHighlight:!0,autoSelect:k,PaperComponent:y,...C,ListboxProps:w,renderGroup:M,renderInput:G,slotProps:I,sx:B}),(0,t.jsx)(x.A,{...m})]})}},43620:(e,r,n)=>{n.d(r,{A:()=>O});var t=n(37876),o=n(11532),s=n(7227),i=n(83221),l=n(83911),a=n(50046),u=n.n(a),c=n(14232),d=n(10595),m=n(41282),h=n(77630),p=n(31381),g=n(36872),v=n(44725),x=n(77617),j=n(76759),y=n(91549),A=n(78175),b=n(96363),f=n(36269);let k=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];let[o]=r,{onClearIndicatorClick:s,...i}=o,{sx:a,value:u,...m}=i,h=(0,c.useMemo)(()=>({["& .".concat(l.A.icon)]:{color:d.Qu},["& .".concat(b.A.root)]:{marginRight:".8em"},["& .".concat(x.A.root)]:{color:d.Qu,visibility:"hidden"},["&:hover .".concat(b.A.root," .").concat(x.A.root,",\n      &.").concat(y.A.focused," .").concat(b.A.root," .").concat(x.A.root)]:{visibility:"visible"},...a}),[a]),p=(0,c.useMemo)(()=>{if(u&&s)return(0,t.jsx)(f.A,{position:"end",children:(0,t.jsx)(j.A,{onClick:s,tabIndex:-1,children:(0,t.jsx)(v.A,{fontSize:"small"})})})},[s,u]);return(0,t.jsx)(A.A,{endAdornment:p,value:u,...m,sx:h})},O=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];let[a]=r,{id:v,label:x,selectItems:j,checkItem:y,disableItem:A,formControlProps:b,hideItem:f,inputLabelProps:O={},isReadOnly:C=!1,messageBoxProps:I={},name:w,noOptionsText:M="No options",onBlur:G,onChange:B,onFocus:S,required:P,selectProps:{MenuProps:F,multiple:z,sx:U,...W}={},value:D,isCheckableItems:N=z}=a,E=(0,c.useMemo)(()=>C?u()({["& .".concat(l.A.icon)]:{visibility:"hidden"}},U):U,[C,U]),q=(0,c.useCallback)(e=>N&&(0,t.jsx)(o.A,{checked:null==y?void 0:y.call(null,e)}),[y,N]),L=(0,c.useCallback)((e,r)=>(0,t.jsxs)(h.A,{disabled:null==A?void 0:A.call(null,e),sx:{display:(null==f?void 0:f.call(null,e))?"none":void 0},value:e,children:[q(e),r]},"".concat(v,"-").concat(e)),[q,A,f,v]),T=(0,c.useMemo)(()=>"".concat(v,"-select-element"),[v]),$=(0,c.useMemo)(()=>(0,t.jsx)(p.A,{id:v,label:x,required:P}),[v,x,P]),Q=(0,c.useMemo)(()=>x&&(0,t.jsx)(g.A,{htmlFor:T,...O,children:x}),[O,x,T]),R=(0,c.useMemo)(()=>j.length?j.map(e=>{if("string"==typeof e)return L(e,e);let{value:r,displayValue:n=String(r)}=e;return L(r,n)}):(0,t.jsx)(h.A,{disabled:!0,children:M}),[L,M,j]),Z=(0,c.useMemo)(()=>u()({sx:{["& .".concat(i.A.paper)]:{backgroundColor:d.Qu}}},F),[F]);return(0,t.jsxs)(s.A,{fullWidth:!0,...b,children:[Q,(0,t.jsx)(k,{id:T,input:$,MenuProps:Z,multiple:z,name:w,onBlur:G,onChange:B,onFocus:S,readOnly:C,value:D,...W,sx:E,children:R}),(0,t.jsx)(m.A,{...I})]})}},44082:(e,r,n)=>{n.d(r,{A:()=>s});let t=(e,r)=>{let n,t,o,{free:s,size:i,used:l,uuid:a,...u}=r;try{n=BigInt(s),t=BigInt(i),o=BigInt(l)}catch(r){return e}return e[a]={...u,free:n,size:t,used:o,uuid:a},e},o=(e,r)=>{let n,{uuid:t}=r;try{n=(e=>{let{free:r,size:n,used:t,uuid:o,...s}=e,i=BigInt(r),l=BigInt(n),a=BigInt(t);return{...s,free:i,size:l,used:a,uuid:o}})(r)}catch(r){return e}return e[t]=n,e},s=e=>{let r,n,s,{storageGroupTotals:i,storageGroups:l,volumeGroups:a,...u}=e,c=Object.values(l).reduce(t,{}),d=Object.values(a).reduce(o,{});try{r=BigInt(i.free),n=BigInt(i.size),s=BigInt(i.used)}catch(e){return{...u,storageGroups:c,totalFree:BigInt(0),totalSize:BigInt(0),totalUsed:BigInt(0),volumeGroups:d}}return{...u,storageGroups:c,totalFree:r,totalSize:n,totalUsed:s,volumeGroups:d}}},61931:(e,r,n)=>{n.d(r,{A:()=>l});var t=n(37876),o=n(14232),s=n(39294),i=n(40038);let l=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{initial:{actionProceedText:r="",content:n="",titleText:l="",...a}={}}=e,u=(0,o.useRef)(null),[c,d]=(0,o.useState)({actionProceedText:r,content:n,titleText:l}),m=(0,o.useCallback)(e=>d(r=>{let{loading:n,...t}=r;return{...t,loading:e}}),[]),h=(0,o.useCallback)(e=>{var r,n;return null==u||null==(n=u.current)||null==(r=n.setOpen)?void 0:r.call(null,e)},[]),p=(0,o.useCallback)((e,r)=>d({actionProceedText:"",content:(0,t.jsx)(i.A,{...r}),showActionArea:!1,showClose:!0,titleText:e}),[]);return{confirmDialog:(0,o.useMemo)(()=>(0,t.jsx)(s.A,{...a,...c,ref:u}),[c,a]),confirmDialogRef:u,setConfirmDialogLoading:m,setConfirmDialogOpen:h,setConfirmDialogProps:d,finishConfirm:p}}},69397:(e,r,n)=>{n.d(r,{A:()=>t});let t=(e,r)=>{let n;try{n=Object.keys(e)}catch(e){n=[]}let t="function"==typeof r?r:()=>r;return n.reduce((r,n)=>{let{[n]:o}=e;return r[n]=t(n,o),r},{})}},72271:(e,r,n)=>{n.d(r,{A:()=>t});let t={states:{blocking:["deleting","in bootup","in shutdown","provisioning","renaming"],map:new Map([["running","Running"],["idle","Idle"],["paused","Paused"],["in shutdown","Shutting Down"],["shut off","Off"],["crashed","Crashed"],["pmsuspended","PM Suspended"],["migrating","Migrating"],["provisioning","Provisioning"]])}}},77630:(e,r,n)=>{n.d(r,{A:()=>l});var t=n(93621),o=n(93267),s=n(35268),i=n(10595);let l=(0,s.Ay)(t.A)({backgroundColor:i.Qu,paddingRight:"3em",["&.".concat(o.A.selected)]:{backgroundColor:i.a$,fontWeight:400,["&.".concat(o.A.focusVisible)]:{backgroundColor:i.a$},"&:hover":{backgroundColor:i.a$}},["&.".concat(o.A.focusVisible)]:{backgroundColor:i.a$},"&:hover":{backgroundColor:i.a$}})},77782:(e,r,n)=>{n.d(r,{_0:()=>W,Yy:()=>E,l9:()=>q,kL:()=>V});var t=n(37876),o=n(14232),s=n(31254),i=n(38750),l=n(20795);let a=e=>{let{files:r,nodes:n,servers:t,storageGroups:o,subnodes:s}=e;return{files:r,nodes:Object.values(n).reduce((e,r)=>{let{memory:n,...t}=r;return e[r.uuid]={...t,memory:{allocated:BigInt(n.allocated),available:BigInt(n.available),system:BigInt(n.system),total:BigInt(n.total)}},e},{}),servers:Object.values(t).reduce((e,r)=>{let{memory:n,...t}=r;return e[r.uuid]={...t,memory:{total:BigInt(n.total)}},e},{}),storageGroups:Object.values(o).reduce((e,r)=>{let{usage:n,...t}=r;return e[r.uuid]={...t,usage:{free:BigInt(n.free),total:BigInt(n.total),used:BigInt(n.used)}},e},{}),subnodes:Object.values(s).reduce((e,r)=>{let{memory:n,...t}=r;return e[r.uuid]={...t,memory:{total:BigInt(n.total)}},e},{})}};var u=n(40038),c=n(7254),d=n(41316),m=n(68707),h=n(69647),p=n(41946),g=n.n(p),v=n(22346),x=n(48937),j=n(28850),y=n(43010),A=n(74235),b=n(35268),f=n(89121);let k=(0,b.Ay)(f.A)({minWidth:"unset",whiteSpace:"nowrap"}),O=e=>{let{children:r,onClick:n,slotProps:o}=e;return(0,t.jsxs)(k,{onClick:n,...null==o?void 0:o.button,children:["Max: ",r]})};var C=n(67820),I=n(69146),w=n(21967),M=n(88259);let G=e=>{let{formikUtils:r,id:n,resources:s,scope:i}=e,{changeFieldValue:a,formik:u,handleChange:c}=r,p=(0,o.useMemo)(()=>{let e="disks.".concat(n),r="".concat(e,".size");return{size:r,unit:"".concat(r,".unit"),value:"".concat(r,".value"),storageGroup:"".concat(e,".storageGroup")}},[n]),g=(0,o.useMemo)(()=>({uuids:Object.keys(s.storageGroups)}),[s.storageGroups]),x=(0,o.useCallback)(e=>{let{[e]:r}=s.storageGroups,{[r.node]:n}=s.nodes;return{node:n,sg:r}},[s.nodes,s.storageGroups]),j=u.values.disks[n],A=(0,o.useMemo)(()=>i.reduce((e,r)=>{let{storageGroup:n}=r,t=s.storageGroups[n];return t.usage.free>e?t.usage.free:e},BigInt(0)),[s.storageGroups,i]),b=(0,o.useMemo)(()=>{let e=(0,h.u7)(A,{toUnit:j.size.unit});return e?{...e,str:"".concat(e.value," ").concat(e.unit)}:{str:"unknown",unit:"B",value:"0"}},[j.size.unit,A]);return(0,t.jsxs)(d.Ay,{container:!0,spacing:"1em",children:[(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(M.A,{input:(0,t.jsx)(w.A,{id:p.size,label:"Disk ".concat(n,": size"),inputWithLabelProps:{id:p.value,inputProps:{endAdornment:(0,t.jsx)(O,{onClick:()=>{a(p.value,b.value,!0)},children:b.str})},name:p.value,required:!0},onChange:c,selectItems:v.W,selectWithLabelProps:{id:p.unit,name:p.unit,onChange:u.handleChange,value:j.size.unit},value:j.size.value})})}),(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(y.A,{filterOptions:(0,m.Z)({ignoreCase:!0,stringify:e=>{let{node:r,sg:n}=x(e);return"".concat(n.name,"\n").concat(r.name)}}),getOptionDisabled:e=>i.every(r=>r.storageGroup!==e),getOptionLabel:e=>{let{node:r,sg:n}=x(e);return"".concat(n.name," (").concat(r.name,")")},id:p.storageGroup,isOptionEqualToValue:(e,r)=>e===r,label:"Disk ".concat(n,": storage group"),noOptionsText:"No matching storage group",onChange:(e,r)=>{a(p.storageGroup,r,!0)},openOnFocus:!0,options:g.uuids,renderOption:(e,r)=>{let{node:n,sg:s}=x(r);return(0,o.createElement)("li",{...e,key:"storage-group-op-".concat(r)},(0,t.jsxs)(d.Ay,{alignItems:"center",container:!0,children:[(0,t.jsxs)(d.Ay,{item:!0,xs:!0,children:[(0,t.jsx)(l.a3,{inheritColour:!0,noWrap:!0,children:s.name}),(0,t.jsx)(l.a3,{inheritColour:!0,noWrap:!0,children:n.name})]}),(0,t.jsx)(d.Ay,{item:!0,children:(0,t.jsxs)(l.a3,{inheritColour:!0,noWrap:!0,children:[(0,h.zz)(s.usage.free,{toUnit:"ibyte"})," free"]})})]}))},required:!0,value:j.storageGroup})})]})};var B=n(45944);let S=e=>{let{resources:r}=e,n=(0,o.useMemo)(()=>Object.values(r.servers).sort((e,r)=>r.name.localeCompare(e.name,void 0,{numeric:!0})).reduce((e,r)=>(e[r.uuid]=r,e),{}),[r.servers]);return(0,t.jsx)(B.A,{header:"Existing",listItems:n,listProps:{dense:!0,sx:{maxHeight:"calc(60vh - 12em)"}},renderListItem:(e,r)=>(0,t.jsx)(l.a3,{children:r.name}),scroll:!0})},P=e=>{let{lsos:r,resources:n,values:s}=e,i=(0,o.useMemo)(()=>({ids:Object.keys(s.disks)}),[s.disks]),a=(0,o.useMemo)(()=>n.nodes[s.node],[n.nodes,s.node]);return(0,t.jsxs)(d.Ay,{container:!0,rowSpacing:"0.5em",children:[(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsxs)(l.a3,{children:["Server ",(0,t.jsx)(l.kp,{children:s.name})," will be created on node ",(0,t.jsx)(l.kp,{children:a.name})," with the following properties:"]})}),(0,t.jsx)(d.Ay,{item:!0,width:"30%",children:(0,t.jsx)(l.a3,{children:"CPU"})}),(0,t.jsx)(d.Ay,{item:!0,width:"70%",children:(0,t.jsxs)(l.a3,{children:[(0,t.jsx)(l.kp,{edge:"start",children:s.cpu.cores})," ","core(s) of ",(0,t.jsx)(l.kp,{children:a.cpu.cores.total})," ","available"]})}),(0,t.jsx)(d.Ay,{item:!0,width:"30%",children:(0,t.jsx)(l.a3,{children:"Memory"})}),(0,t.jsx)(d.Ay,{item:!0,width:"70%",children:(0,t.jsxs)(l.a3,{children:[(0,t.jsxs)(l.kp,{edge:"start",children:[s.memory.value," ",s.memory.unit]})," ","of"," ",(0,t.jsx)(l.kp,{children:(0,h.zz)(a.memory.available,{toUnit:"ibyte"})})," ","available"]})}),...i.ids.reduce((e,r)=>{let{[r]:o}=s.disks,i="disk-".concat(r,"-sum"),{[o.storageGroup]:a}=n.storageGroups;return e.push((0,t.jsx)(d.Ay,{item:!0,width:"30%",children:(0,t.jsxs)(l.a3,{children:["Disk ",(0,t.jsx)(l.kp,{children:r})]})},"".concat(i,"-label")),(0,t.jsx)(d.Ay,{item:!0,width:"70%",children:(0,t.jsxs)(l.a3,{children:[(0,t.jsxs)(l.kp,{edge:"start",children:[o.size.value," ",o.size.unit]})," ","of"," ",(0,t.jsx)(l.kp,{children:(0,h.zz)(a.usage.free,{toUnit:"ibyte"})})," ","free on ",(0,t.jsx)(l.kp,{children:a.name})]})},"".concat(i,"-value"))),e},[]),(0,t.jsx)(d.Ay,{item:!0,width:"30%",children:(0,t.jsx)(l.a3,{children:"Install ISO"})}),(0,t.jsx)(d.Ay,{item:!0,width:"70%",children:(0,t.jsx)(l.a3,{children:(0,t.jsx)(l.kp,{edge:"start",children:n.files[s.install].name})})}),(0,t.jsx)(d.Ay,{item:!0,width:"30%",children:(0,t.jsx)(l.a3,{children:"Driver ISO"})}),(0,t.jsx)(d.Ay,{item:!0,width:"70%",children:(0,t.jsx)(l.a3,{children:(0,t.jsx)(l.kp,{edge:"start",children:s.driver?n.files[s.driver].name:"none"})})}),(0,t.jsx)(d.Ay,{item:!0,width:"30%",children:(0,t.jsx)(l.a3,{children:"Optimize for"})}),(0,t.jsx)(d.Ay,{item:!0,width:"70%",children:(0,t.jsx)(l.a3,{children:(0,t.jsx)(l.kp,{edge:"start",children:r[s.os]})})})]})};var F=n(91408),z=n(27743);let U=BigInt(0x6400000),W=e=>(0,z.Yj)({max:e,min:U}),D=BigInt(0),N=BigInt(65536),E=e=>(0,z.Yj)({max:e,min:N}),q=(e,r)=>{let n;return n=r instanceof Array?r:Object.values(r),e&&(n=n.filter(r=>r.uuid!==e)),F.Yj().min(1).max(32).matches(/^[\w-]+$/,{message:"${path} can only contain alphanumeric, hyphen, and underscore characters"}).notOneOf(n.map(e=>e.name),"${path} already exists").required()};var L=n(69397);let T=BigInt(0);var $=n(61931),Q=n(93647);let R=e=>{let{lsos:r,resources:n}=e,i=(0,o.useContext)(s.MV),a=(0,o.useMemo)(()=>({uuids:Object.keys(n.files)}),[n.files]),p=(0,o.useMemo)(()=>({uuids:Object.keys(n.nodes),values:Object.values(n.nodes)}),[n.nodes]),b=(0,o.useMemo)(()=>({keys:Object.keys(r).sort((e,r)=>r.localeCompare(e,void 0,{numeric:!0}))}),[r]),f=(0,o.useMemo)(()=>({uuids:Object.keys(n.storageGroups),values:Object.values(n.storageGroups)}),[n.storageGroups]),k=(0,o.useMemo)(()=>p.values.reduce((e,r)=>(r.storageGroups.forEach(n=>{e.push({node:r.uuid,storageGroup:n})}),e),[]),[p.values]),[B,U]=(0,o.useState)(k),{confirmDialog:N,finishConfirm:R,setConfirmDialogProps:Z,setConfirmDialogLoading:V,setConfirmDialogOpen:_}=(0,$.A)(),Y=(0,o.useMemo)(()=>((e,r,n)=>{let t,o=e.map(e=>r.nodes[e.node]).reduce((e,r)=>{let{cpu:n,memory:t}=r;return n.cores.total>e.cpu.cores&&(e.cpu.cores=n.cores.total),t.available>e.memory.available&&(e.memory.available=t.available),e},{cpu:{cores:0},memory:{available:T}}),s=Object.keys(n);return F.Ik({cpu:F.Ik({cores:(t=o.cpu.cores,F.ai().min(1).max(t).required())}),disks:F.RZ(n=>F.Ik((0,L.A)(n,((e,r)=>{let n=e.map(e=>r.storageGroups[e.storageGroup]).reduce((e,r)=>(r.usage.free>e.free&&(e.free=r.usage.free),e),{free:D});return F.Ik({size:F.gl().when(["storageGroup"],e=>{let[t]=e,{[t]:o}=r.storageGroups;return o?W(o.usage.free):W(n.free)}),storageGroup:(0,z.ZC)()})})(e,r)))),driver:(0,z.ZC)().notOneOf([F.KR("install")]).nullable(),install:(0,z.ZC)().notOneOf([F.KR("driver")]).required(),memory:E(o.memory.available),name:q(null,r.servers),node:(0,z.ZC)().oneOf(e.map(e=>e.node)).required(),os:F.Yj().oneOf(s)})})(B,n,r),[r,n,B]),K=(0,Q.A)({initialValues:{cpu:{cores:"2"},disks:{0:{size:{unit:"GiB",value:"20"},storageGroup:null}},driver:null,install:null,memory:{unit:"GiB",value:"1"},name:"",node:null,os:null},onSubmit:(e,o)=>{let{setSubmitting:s}=o;Z({actionProceedText:"Provision",content:(0,t.jsx)(P,{lsos:r,resources:n,values:e}),onCancelAppend:()=>s(!1),onProceedAppend:()=>{let r;V(!0);let n=(0,h.u7)(e.memory.value,{fromUnit:e.memory.unit,precision:0,toUnit:"B"});if(!n)return void R("Error",{children:(0,t.jsx)(t.Fragment,{children:"Failed to convert memory to bytes."})});try{r=Object.keys(e.disks).map(r=>{let{[r]:n}=e.disks,{size:t,storageGroup:o}=n,s=(0,h.u7)(t.value,{fromUnit:t.unit,precision:0,toUnit:"B"});if(!s)throw Error("Failed to convert disk ".concat(r," size to bytes."));return{storageSize:s.value,storageGroupUUID:o}})}catch(e){R("Error",{children:String(e)});return}let o={serverName:e.name,cpuCores:Number(e.cpu.cores),memory:n.value,virtualDisks:r,installISOFileUUID:e.install,driverISOFileUUID:e.driver?e.driver:"",anvilUUID:e.node,optimizeForOS:e.os};j.A.post("/server",o).then(()=>{R("Success",{children:(0,t.jsx)(t.Fragment,{children:"Provision server job registered."})}),null==i||i.setOpen(!1)}).catch(e=>{let r=(0,A.A)(e);r.children=(0,t.jsxs)(t.Fragment,{children:["Failed to start provision server job. ",r.children]}),R("Error",r),s(!1)})},titleText:"Provision ".concat(e.name,"?")}),_(!0)},validationSchema:Y}),{changeFieldValue:H,disabledSubmit:J,formik:X,formikErrors:ee,getFieldChanged:er,handleChange:en}=K,et=(0,o.useMemo)(()=>({cpu:{cores:"cpu.cores"},driver:"driver",install:"install",memory:{unit:"memory.unit",value:"memory.value"},name:"name",node:"node",os:"os"}),[]),eo=(0,o.useMemo)(()=>({ids:Object.keys(X.values.disks)}),[X.values.disks]);(0,o.useEffect)(()=>{let e=[...k];X.values.node&&(e=e.filter(e=>e.node===X.values.node));let r=Number(X.values.cpu.cores);Number.isSafeInteger(r)&&(e=e.filter(e=>{let{[e.node]:t}=n.nodes;return t.cpu.cores.total>=r}));let t=(0,h.u7)(X.values.memory.value,{fromUnit:X.values.memory.unit,precision:0,toUnit:"B"});if(t){let r=BigInt(t.value);e=e.filter(e=>{let{[e.node]:t}=n.nodes;return t.memory.available>=r})}eo.ids.forEach(r=>{let{size:t,storageGroup:o}=X.values.disks[r];if(o){let{[o]:r}=n.storageGroups;e=e.filter(e=>e.node===r.node)}let s=(0,h.u7)(t.value,{fromUnit:t.unit,precision:0,toUnit:"B"});if(s){let r=BigInt(s.value);e=e.filter(e=>{let{[e.storageGroup]:t}=n.storageGroups;return t.usage.free>=r})}}),g()(B,e)||U(e)},[eo.ids,X.values.cpu.cores,X.values.disks,X.values.memory.unit,X.values.memory.value,X.values.node,k,n.nodes,n.storageGroups,B]),(0,o.useEffect)(()=>{if(1===a.uuids.length){let[e]=a.uuids;[er(et.install),X.values.install].every(e=>!e)&&X.setFieldValue(et.install,e,!0)}let e=B.reduce((e,r)=>{let{node:n,storageGroup:t}=r;return e.nodes[n]=n,e.storageGroups[t]=t,e},{nodes:{},storageGroups:{}}),r=Object.keys(e.nodes);if(1===r.length){let[e]=r;[er(et.node),X.values.node].every(e=>!e)&&X.setFieldValue(et.node,e,!0)}let n=Object.keys(e.storageGroups);if(1===n.length){let[e]=n;eo.ids.forEach(r=>{let n="disks.".concat(r,".storageGroup");[er(n),X.values.disks[r].storageGroup].every(e=>!e)&&X.setFieldValue(n,e,!0)})}},[et.install,et.node,eo.ids,a.uuids,X,er,B]);let es=(0,o.useMemo)(()=>B.reduce((e,r)=>{let{node:t}=r,o=n.nodes[t];return o.memory.available>e?o.memory.available:e},BigInt(0)),[n.nodes,B]),ei=(0,o.useMemo)(()=>{let e=(0,h.u7)(es,{toUnit:X.values.memory.unit});return e?{...e,str:"".concat(e.value," ").concat(e.unit)}:{str:"unknown",unit:"B",value:"0"}},[X.values.memory.unit,es]),el=(0,o.useMemo)(()=>Array.from({length:p.values.reduce((e,r)=>Math.max(e,r.cpu.cores.total),0)},(e,r)=>String(r+1)),[p]),ea=(0,o.useCallback)(e=>{let{[e]:r}=n.files;return r.name},[n.files]),eu=(0,o.useMemo)(()=>(0,m.Z)({ignoreCase:!0,stringify:e=>{let{[e]:r}=n.files;return r.name}}),[n.files]),ec=(0,o.useCallback)((e,r,s)=>{let{[s]:i}=n.files,a=Object.values(i.locations).reduce((e,r)=>{let{ready:t,subnode:o}=r,{[o]:s}=n.subnodes;return t||!s||e.push(s),e},[]),u=a.length?(0,t.jsxs)(t.Fragment,{children:["Syncing to ",a.map(e=>{let{short:r}=e;return r}).join(", ")]}):(0,t.jsx)(t.Fragment,{children:"Ready"});return(0,o.createElement)("li",{...r,key:"".concat(e,"-op-").concat(s)},(0,t.jsxs)(c.A,{width:"100%",children:[(0,t.jsx)(l.a3,{inheritColour:!0,noWrap:!0,children:i.name}),(0,t.jsx)(l.xF,{inheritColour:!0,noWrap:!0,children:u})]}))},[n.files,n.subnodes]),ed=(0,o.useMemo)(()=>{let e={};return[["file",a.uuids.length],["node",p.uuids.length],["storage group",f.uuids.length]].reduce((e,r)=>{let[n,o]=r;return o||(e[n]={children:(0,t.jsxs)(t.Fragment,{children:["No ",n," available yet. It will appear shortly after its creation."]})}),e},e),{entries:Object.entries(e),messages:e}},[a.uuids.length,p.uuids.length,f.uuids.length]);if(ed.entries.length){let{entries:e}=ed;return(0,t.jsx)(d.Ay,{container:!0,spacing:"1em",children:e.map(e=>{let[r,n]=e;return(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(u.A,{type:"warning",...n})},"".concat(r,"-message"))})})}return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(d.Ay,{container:!0,spacing:"1em",children:[(0,t.jsx)(d.Ay,{item:!0,width:"16em",children:(0,t.jsx)(S,{resources:n})}),(0,t.jsx)(d.Ay,{item:!0,xs:!0,children:(0,t.jsxs)(d.Ay,{component:"form",container:!0,onSubmit:e=>{e.preventDefault(),X.handleSubmit(e)},spacing:"1em",children:[(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(M.A,{input:(0,t.jsx)(I.A,{id:et.name,label:"Server name",name:et.name,onChange:en,required:!0,value:X.values.name})})}),(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(y.A,{getOptionDisabled:e=>{let r=Number(e);return B.every(e=>{let{[e.node]:t}=n.nodes;return t.cpu.cores.total<r})},id:et.cpu.cores,label:"CPU cores",noOptionsText:"No node has the requested cores",onChange:(e,r)=>{H(et.cpu.cores,r,!0)},openOnFocus:!0,options:el,required:!0,value:X.values.cpu.cores})}),(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(M.A,{input:(0,t.jsx)(w.A,{id:"memory",inputWithLabelProps:{id:et.memory.value,inputProps:{endAdornment:(0,t.jsx)(O,{onClick:()=>{H(et.memory.value,ei.value,!0)},children:ei.str})},name:et.memory.value,required:!0},label:"Memory",onChange:en,selectItems:v.W,selectWithLabelProps:{id:et.memory.unit,name:et.memory.unit,onChange:X.handleChange,value:X.values.memory.unit},value:X.values.memory.value})})}),eo.ids.map(e=>(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(G,{formikUtils:K,id:e,resources:n,scope:B})},"disk-".concat(e,"-form"))),(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(y.A,{filterOptions:eu,getOptionDisabled:e=>e===X.values.driver,getOptionLabel:ea,id:et.install,label:"Install ISO",noOptionsText:"No matching ISO",onChange:(e,r)=>{H(et.install,r,!0)},openOnFocus:!0,options:a.uuids,renderOption:(e,r)=>ec(et.install,e,r),required:!0,value:X.values.install})}),(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(y.A,{filterOptions:eu,getOptionDisabled:e=>e===X.values.install,getOptionLabel:ea,id:et.driver,label:"Driver ISO",noOptionsText:"No matching ISO",onChange:(e,r)=>{H(et.driver,r,!0)},openOnFocus:!0,options:a.uuids,renderOption:(e,r)=>ec(et.driver,e,r),value:X.values.driver})}),(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(y.A,{filterOptions:(0,m.Z)({ignoreCase:!0,stringify:e=>{let{[e]:r}=n.nodes;return"".concat(r.name,"\n").concat(r.description)}}),getOptionDisabled:e=>B.every(r=>r.node!==e),getOptionLabel:e=>{let{[e]:r}=n.nodes;return r.name},id:et.node,label:"Node",noOptionsText:"No matching node",onChange:(e,r)=>{H(et.node,r,!0)},openOnFocus:!0,options:p.uuids,renderOption:(e,r)=>{let{[r]:s}=n.nodes;return(0,o.createElement)("li",{...e,key:"node-op-".concat(r)},(0,t.jsxs)(d.Ay,{alignItems:"center",container:!0,children:[(0,t.jsxs)(d.Ay,{item:!0,width:"70%",children:[(0,t.jsx)(l.a3,{inheritColour:!0,noWrap:!0,children:s.name}),(0,t.jsx)(l.xF,{inheritColour:!0,noWrap:!0,children:s.description})]}),(0,t.jsxs)(d.Ay,{item:!0,width:"30%",children:[(0,t.jsxs)(l.a3,{inheritColour:!0,noWrap:!0,children:["CPU: ",s.cpu.cores.total," cores"]}),(0,t.jsxs)(l.a3,{inheritColour:!0,noWrap:!0,children:["Memory:"," ",(0,h.zz)(s.memory.available,{toUnit:"ibyte"})]})]})]}))},required:!0,value:X.values.node})}),(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(y.A,{filterOptions:(0,m.Z)({ignoreCase:!0,stringify:e=>{let{[e]:n}=r;return"".concat(e,"\n").concat(n)}}),getOptionLabel:e=>{let{[e]:n}=r;return n},id:et.os,label:"Optimize for OS",noOptionsText:"No OS that matches exactly; try finding a close match",onChange:(e,r)=>{H(et.os,r,!0)},openOnFocus:!0,options:b.keys,renderOption:(e,n)=>{let{[n]:s}=r;return(0,o.createElement)("li",{...e,key:"os-op-".concat(n)},(0,t.jsxs)(c.A,{width:"100%",children:[(0,t.jsx)(l.a3,{inheritColour:!0,noWrap:!0,children:s}),(0,t.jsx)(l.xF,{inheritColour:!0,noWrap:!0,children:n})]}))},required:!0,value:X.values.os})}),(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(C.A,{count:1,messages:ee})}),(0,t.jsx)(d.Ay,{item:!0,width:"100%",children:(0,t.jsx)(x.A,{actions:[{background:"blue",children:"Provision",disabled:J,type:"submit"}]})})]})})]}),N]})};var Z=n(30827);let V=()=>{let e=(0,o.useRef)(null),{form:r,loading:n,validating:c}=(()=>{let{data:e,loading:r}=(0,Z.A)("/server/lsos"),{altData:n,loading:s,validating:i}=(0,Z.A)("/server/provision",{mod:a,refreshInterval:5e3});return{form:(0,o.useMemo)(()=>[e,n].some(e=>!e)?(0,t.jsx)(u.A,{type:"warning",children:"Failed to prepare resources for provision server."}):(0,t.jsx)(R,{lsos:e,resources:n}),[e,n]),loading:r||s,lsos:e,resources:n,validating:i}})(),d=(0,o.useCallback)(function(){var r;let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return null==(r=e.current)?void 0:r.setOpen(n)},[]);return{dialog:(0,o.useMemo)(()=>(0,t.jsx)(s.K_,{header:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(l.HM,{children:"Provision a server"}),(0,t.jsx)(i.A,{syncing:c})]}),loading:n,ref:e,showClose:!0,wide:!0,children:r}),[r,n,c]),setOpen:d}}}}]);