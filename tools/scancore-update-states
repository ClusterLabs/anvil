#!/usr/bin/perl
# 
# This is the master daemon that manages all periodically run processes on Striker dashboards and Anvil! 
# nodes.
# 
use strict;
use warnings;
use AN::Tools;

my $THIS_FILE           =  ($0 =~ /^.*\/(.*)$/)[0];
my $running_directory   =  ($0 =~ /^(.*?)\/$THIS_FILE$/)[0];
if (($running_directory =~ /^\./) && ($ENV{PWD}))
{
	$running_directory =~ s/^\./$ENV{PWD}/;
}

my $an = AN::Tools->new();
$an->Log->level(2);

# Turn off buffering so that the pinwheel will display while waiting for the SSH call(s) to complete.
$| = 1;


# my $shell_call = "/sys/class/net/ens11/address";
# $an->Log->entry({source => $THIS_FILE, line => __LINE__, level => 2, key => "log_0012", variables => { shell_call => $shell_call }});
# open (my $file_handle, "<$shell_call") or $an->Log->entry({source => $THIS_FILE, line => __LINE__, level => 0, priority => "err", key => "log_0015", variables => { shell_call => $shell_call, error => $! }});;
# while(<$file_handle>)
# {
# 	chomp;
# 	my $line = $_;
# 	$an->Log->entry({source => $THIS_FILE, line => __LINE__, level => 2, key => "log_0023", variables => { output => $line }});
# 	print "line: [$line]\n";
# }
# close 

my $status =  "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
   $status .= "<status>\n";
   $status .= report_network($an);
   $status .= "</status>\n";
   
### TODO: Set the 'status.xml' name into 'striker.conf'
# Write the file.
my $output_file = $an->data->{path}{directories}{html}."/status.xml";
$an->Log->variables({source => $THIS_FILE, line => __LINE__, level => 3, list => { output_file => $output_file }});
$an->Storage->write_file({
	file      => $output_file, 
	body      => $status, 
	overwrite => 1,
	mode      => "0644", 
	user      => "apache", 
	group     => "apache"
});

exit(0);

#############################################################################################################
# Functions                                                                                                 #
#############################################################################################################

# This reports the current network interface states, tracked by the MAC address.
sub report_network
{
	my ($an) = @_;
	
	my $network = "	<network>\n";
	my $directory = $an->data->{path}{sysfs}{network_interfaces};
	local(*DIRECTORY);
	$an->Log->entry({source => $THIS_FILE, line => __LINE__, level => 3, key => "log_0018", variables => { directory => $directory }});
	opendir(DIRECTORY, $directory);
	while(my $file = readdir(DIRECTORY))
	{
		next if $file eq ".";
		next if $file eq "..";
		next if $file eq "lo";
		my $full_path = "$directory/$file";
		$an->Log->variables({source => $THIS_FILE, line => __LINE__, level => 3, list => { full_path => $full_path }});
		if (-d $full_path)
		{
			# Pull out the data I want.
			my $interface   = $file;
			my $mac_address = $an->Storage->read_file({file => $full_path."/address"});
			my $link_state  = $an->Storage->read_file({file => $full_path."/carrier"});
			my $mtu         = $an->Storage->read_file({file => $full_path."/mtu"});
			my $duplex      = $an->Storage->read_file({file => $full_path."/duplex"});	# full or half?
			my $operational = $an->Storage->read_file({file => $full_path."/operstate"});	# up or down
			my $speed       = $link_state ? $an->Storage->read_file({file => $full_path."/speed"}) : 0;	# Mbps (ie: 1000 = Gbps), gives a very high number for unplugged link
			$an->Log->variables({source => $THIS_FILE, line => __LINE__, level => 3, list => { 
				interface   => $interface, 
				mac_address => $mac_address, 
				link_state  => $link_state, 
				mtu         => $mtu, 
				duplex      => $duplex,
				operational => $operational,
				speed       => $speed,
			}});
			$network .= "		<interface name=\"$interface\" mac=\"$mac_address\" link=\"$link_state\" duplex=\"$duplex\" state=\"$operational\" speed=\"$speed\">\n";
		}
	}
	closedir(DIRECTORY);
	$network .= "	<network>\n";
	
	$an->Log->variables({source => $THIS_FILE, line => __LINE__, level => 3, list => { network => $network }});
	return($network);
}
